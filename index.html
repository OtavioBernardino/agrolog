<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroLog Pro Cloud - Master System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCy2_TVj_AXhu2HUlQBUuL3nUkYWGVzA0U",
            authDomain: "agrolog-f89d7.firebaseapp.com",
            databaseURL: "https://agrolog-f89d7-default-rtdb.firebaseio.com",
            projectId: "agrolog-f89d7",
            storageBucket: "agrolog-f89d7.firebasestorage.app",
            messagingSenderId: "79965062136",
            appId: "1:79965062136:web:1361b2e7001ad850288c0d",
            measurementId: "G-2YKKE82KTD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const frotaRef = ref(db, 'frota');
        const tiposRevRef = ref(db, 'tipos_revisao');
        const logsRef = ref(db, 'logs');
        const operRef = ref(db, 'operadores');

        onValue(frotaRef, (s) => { 
            const data = s.val();
            window.frota = data ? Object.values(data) : []; 
            window.frotaKeys = data ? Object.keys(data) : []; 
            render(); 
        });
        onValue(tiposRevRef, (s) => { window.tiposRev = s.val() || {}; render(); });
        onValue(logsRef, (s) => { window.logs = s.val() ? Object.values(s.val()).reverse() : []; render(); });
        onValue(operRef, (s) => { window.oper = s.val() ? Object.values(s.val()) : []; render(); });

        window.registrarHoras = (tratorId, operadorNome, horas) => {
            const tIdx = window.frota.findIndex(x => x.id == tratorId);
            const tKey = window.frotaKeys[tIdx];
            update(ref(db, `frota/${tKey}`), { horimetro: parseFloat(horas) });
            push(logsRef, { 
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                maquina: window.frota[tIdx].modelo, quem: operadorNome, valor: horas 
            });
            window.showToast("Dados salvos e sincronizados!", "success");
        };

        window.criarTipoRevisao = (nome, horas) => {
            const id = push(tiposRevRef).key;
            set(ref(db, `tipos_revisao/${id}`), { id, nome, horas: parseFloat(horas) });
            window.showToast("Novo tipo de revisão criado!", "success");
        };

        window.vincularRevisao = (tratorId, tipoId) => {
            const tIdx = window.frota.findIndex(x => x.id == tratorId);
            const tKey = window.frotaKeys[tIdx];
            let planos = window.frota[tIdx].planos || [];
            if (!planos.includes(tipoId)) {
                planos.push(tipoId);
                update(ref(db, `frota/${tKey}`), { planos });
                window.showToast("Revisão associada ao trator!", "success");
            }
        };

        window.removerVinculo = (tratorId, tipoId) => {
            const tIdx = window.frota.findIndex(x => x.id == tratorId);
            const tKey = window.frotaKeys[tIdx];
            let planos = window.frota[tIdx].planos.filter(id => id !== tipoId);
            update(ref(db, `frota/${tKey}`), { planos });
            window.showToast("Vínculo removido do banco!", "warning");
        };

        window.salvarTrator = (mod, hor) => {
            const n = push(frotaRef);
            set(n, { id: Date.now(), modelo: mod, horimetro: parseFloat(hor), ultimaRevisao: parseFloat(hor), planos: [] });
            window.showToast("Máquina adicionada!", "success");
        };

        window.salvarOperador = (nome) => {
            push(operRef, { id: Date.now(), nome });
            window.showToast("Operador cadastrado!", "success");
        };
    </script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #side-menu { transition: transform 0.3s; transform: translateX(-100%); }
        #side-menu.open { transform: translateX(0); }
        .toast { transition: all 0.4s ease; transform: translateY(-20px); opacity: 0; }
        .toast.show { transform: translateY(0); opacity: 1; }
        @media print { .no-print, header, nav, #side-menu { display: none !important; } }
        
        /* Estilos específicos para os filtros de log */
        .filter-input { @apply bg-gray-900 border border-gray-700 rounded-xl p-3 text-xs text-white outline-none focus:border-yellow-600; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-24 font-sans">

    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] w-80 pointer-events-none space-y-2"></div>
    <div id="overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/60 z-[60] hidden"></div>

    <div id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 z-[70] shadow-2xl p-6 border-r border-gray-700">
        <h2 class="text-xl font-black text-yellow-400 italic mb-10">AGROLOG PRO</h2>
        <nav class="space-y-2">
            <button onclick="navTo('dashboard')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-th-large"></i> Dashboard</button>
            <button onclick="navTo('relatorios')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4 text-purple-400"><i class="fas fa-chart-line"></i> Relatórios</button>
            <button onclick="navTo('config-rev')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4 text-orange-400"><i class="fas fa-tools"></i> Planos de Revisão</button>
            <button onclick="navTo('cad-trator')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-plus-circle"></i> Frota & Operadores</button>
        </nav>
    </div>

    <header class="bg-green-900 p-4 sticky top-0 z-50 flex justify-between items-center border-b border-green-800 shadow-xl no-print">
        <button onclick="toggleMenu()" class="text-xl px-2"><i class="fas fa-bars"></i></button>
        <h1 class="font-black italic text-lg uppercase">Agro<span class="text-yellow-400">Log</span> Master</h1>
        <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
    </header>

    <main class="p-4 max-w-4xl mx-auto">
        
        <section id="dashboard" class="tab-content active">
            <div id="fleet-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="relatorios" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl">
                <div class="flex justify-between mb-4">
                    <h2 class="text-purple-400 font-bold uppercase italic">Análise de Horas</h2>
                    <button onclick="window.print()" class="text-xs bg-purple-600 px-3 py-1 rounded-lg">PDF</button>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="filtrarRelatorio('diario')" class="bg-gray-900 p-2 rounded-lg text-[10px] font-bold">HOJE</button>
                    <button onclick="filtrarRelatorio('mensal')" class="bg-gray-900 p-2 rounded-lg text-[10px] font-bold">MÊS</button>
                    <button onclick="filtrarRelatorio('anual')" class="bg-gray-900 p-2 rounded-lg text-[10px] font-bold">ANO</button>
                </div>
                <canvas id="chartProd" class="bg-gray-900 p-2 rounded-xl mb-4" style="max-height: 200px;"></canvas>
                <div id="stats-list" class="space-y-2"></div>
            </div>
        </section>

        <section id="config-rev" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="text-orange-400 font-bold mb-4 uppercase italic text-sm">Categorias</h2>
                <div class="flex gap-2 mb-6">
                    <input type="text" id="rev-n" placeholder="Nome" class="flex-1 bg-gray-900 p-3 rounded-xl border border-gray-700 text-sm">
                    <input type="number" id="rev-h" placeholder="Horas" class="w-20 bg-gray-900 p-3 rounded-xl border border-gray-700 text-sm">
                    <button onclick="window.criarTipoRevisao(document.getElementById('rev-n').value, document.getElementById('rev-h').value)" class="bg-orange-600 px-4 rounded-xl"><i class="fas fa-plus"></i></button>
                </div>
                <h2 class="text-orange-400 font-bold mb-4 uppercase italic text-sm">Vincular</h2>
                <div class="space-y-3">
                    <select id="sel-t-vinc" class="w-full bg-gray-900 p-3 rounded-xl border border-gray-700"></select>
                    <select id="sel-r-vinc" class="w-full bg-gray-900 p-3 rounded-xl border border-gray-700"></select>
                    <button onclick="window.vincularRevisao(document.getElementById('sel-t-vinc').value, document.getElementById('sel-r-vinc').value)" class="w-full bg-orange-600 py-3 rounded-xl font-black text-xs uppercase text-white">Salvar Vínculo</button>
                </div>
            </div>
            <div id="lista-associacoes" class="space-y-2"></div>
        </section>

        <section id="lancamento" class="tab-content">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="text-center font-black uppercase text-yellow-500 mb-6 italic">Sincronizar</h2>
                <form id="form-h" class="space-y-4">
                    <select id="sel-t-lan" class="w-full bg-gray-900 p-4 rounded-xl border border-gray-700 font-bold uppercase"></select>
                    <select id="sel-o-lan" class="w-full bg-gray-900 p-4 rounded-xl border border-gray-700"></select>
                    <input type="number" step="0.1" id="h-input" placeholder="Horímetro" class="w-full bg-gray-900 p-6 rounded-2xl border-2 border-yellow-600 text-center text-5xl font-black text-yellow-500 outline-none">
                    <button class="w-full bg-yellow-600 text-gray-900 py-5 rounded-2xl font-black uppercase shadow-lg">Confirmar</button>
                </form>
            </div>
        </section>

        <section id="cad-trator" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="text-green-500 font-bold mb-4 uppercase italic">Máquina</h2>
                <div class="flex gap-2">
                    <input type="text" id="t-mod-new" placeholder="Modelo" class="flex-1 bg-gray-900 p-3 rounded-xl border border-gray-700">
                    <input type="number" id="t-hor-new" placeholder="Horas" class="w-24 bg-gray-900 p-3 rounded-xl border border-gray-700">
                    <button onclick="window.salvarTrator(document.getElementById('t-mod-new').value, document.getElementById('t-hor-new').value)" class="bg-green-600 px-4 rounded-xl">OK</button>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="text-blue-400 font-bold mb-4 uppercase italic">Operador</h2>
                <div class="flex gap-2">
                    <input type="text" id="o-nome-new" placeholder="Nome" class="flex-1 bg-gray-900 p-3 rounded-xl border border-gray-700">
                    <button onclick="window.salvarOperador(document.getElementById('o-nome-new').value)" class="bg-blue-600 px-4 rounded-xl">OK</button>
                </div>
            </div>
        </section>

        <section id="log-horas" class="tab-content space-y-4">
            <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 shadow-lg space-y-3">
                <h2 class="text-yellow-500 font-black uppercase italic text-sm"><i class="fas fa-filter mr-2"></i>Filtros de Log</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" id="filter-search" oninput="render()" placeholder="Pesquisar máquina ou operador..." class="bg-gray-900 border border-gray-700 rounded-xl p-3 text-xs text-white outline-none focus:border-yellow-600">
                    <input type="date" id="filter-date" onchange="render()" class="bg-gray-900 border border-gray-700 rounded-xl p-3 text-xs text-white outline-none focus:border-yellow-600">
                    <button onclick="clearFilters()" class="bg-gray-700 hover:bg-gray-600 text-[10px] font-bold py-2 rounded-xl uppercase transition">Limpar Filtros</button>
                </div>
            </div>
            <div id="logs-list" class="space-y-2"></div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-md border-t border-gray-700 flex justify-around p-2 z-40 no-print">
        <button onclick="openTab('dashboard')" class="flex flex-col items-center p-2 text-gray-400"><i class="fas fa-tractor text-xl"></i><span class="text-[9px] font-bold">FROTA</span></button>
        <button onclick="openTab('relatorios')" class="flex flex-col items-center p-2 text-purple-400"><i class="fas fa-chart-line text-xl"></i><span class="text-[9px] font-bold">RELAT.</span></button>
        <button onclick="openTab('lancamento')" class="relative -mt-10"><div class="bg-yellow-600 text-gray-900 w-16 h-16 rounded-full flex items-center justify-center border-[6px] border-gray-900"><i class="fas fa-plus"></i></div></button>
        <button onclick="openTab('log-horas')" class="flex flex-col items-center p-2 text-gray-400"><i class="fas fa-history text-xl"></i><span class="text-[9px] font-bold">LOGS</span></button>
    </nav>

    <script>
        let myChart = null;
        window.showToast = (msg, type) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show bg-gray-800 border-l-4 p-4 rounded-xl shadow-2xl flex items-center gap-3 ${type==='success'?'border-green-500':'border-orange-500'}`;
            toast.innerHTML = `<span class="text-sm font-bold">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(), 500); }, 3000);
        };

        function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('overlay').classList.toggle('hidden'); }
        function navTo(id) { toggleMenu(); openTab(id); }
        function openTab(id) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }

        function clearFilters() {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-date').value = '';
            render();
        }

        document.getElementById('form-h').onsubmit = (e) => {
            e.preventDefault();
            window.registrarHoras(document.getElementById('sel-t-lan').value, document.getElementById('sel-o-lan').value, document.getElementById('h-input').value);
            e.target.reset(); openTab('dashboard');
        };

        window.filtrarRelatorio = (periodo) => {
            const stats = {}; window.frota.forEach(t => stats[t.modelo] = 0);
            const agora = new Date();
            window.logs.forEach(log => {
                const [d,m,a] = log.data.split('/');
                const logDate = new Date(a, m-1, d);
                let ok = (periodo==='diario' && logDate.toDateString()===agora.toDateString()) || (periodo==='mensal' && logDate.getMonth()===agora.getMonth()) || (periodo==='anual');
                if(ok && stats[log.maquina] !== undefined) stats[log.maquina] += parseFloat(log.valor);
            });
            renderChart(stats);
        };

        function renderChart(stats) {
            const ctx = document.getElementById('chartProd').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, { type:'bar', data: { labels: Object.keys(stats), datasets:[{ data: Object.values(stats), backgroundColor:'#a855f7' }] }, options: { plugins:{legend:{display:false}}} });
            document.getElementById('stats-list').innerHTML = Object.entries(stats).map(([k,v])=>`<div class="flex justify-between text-xs bg-gray-900 p-2 rounded-lg border-l-2 border-purple-500"><span>${k}</span><b>${v.toFixed(1)}h</b></div>`).join('');
        }

        function render() {
            if(!window.frota || !window.tiposRev) return;

            // Dashboard
            document.getElementById('fleet-list').innerHTML = window.frota.map(t => {
                let barras = (t.planos || []).map(pid => {
                    const r = window.tiposRev[pid];
                    if(!r) return "";
                    const perc = Math.min(((t.horimetro % r.horas) / r.horas) * 100, 100);
                    return `<div class="mt-2"><div class="flex justify-between text-[9px] uppercase font-bold text-gray-500"><span>${r.nome}</span><span>${r.horas}h</span></div><div class="w-full bg-gray-900 h-1.5 rounded-full mt-1"><div class="h-full bg-orange-500" style="width:${perc}%"></div></div></div>`;
                }).join('');
                return `<div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                    <div class="flex justify-between font-black uppercase text-sm mb-2"><span>${t.modelo}</span><span class="text-yellow-500">${t.horimetro}h</span></div>
                    ${barras || '<p class="text-[10px] text-gray-600 italic">Sem planos de manutenção</p>'}
                </div>`;
            }).join('');

            // Selects
            const optT = window.frota.map(t => `<option value="${t.id}">${t.modelo}</option>`).join('');
            document.getElementById('sel-t-vinc').innerHTML = optT;
            document.getElementById('sel-t-lan').innerHTML = optT;
            document.getElementById('sel-r-vinc').innerHTML = Object.values(window.tiposRev).map(r => `<option value="${r.id}">${r.nome} (${r.horas}h)</option>`).join('');
            document.getElementById('sel-o-lan').innerHTML = window.oper.map(o => `<option value="${o.nome}">${o.nome}</option>`).join('');

            // Logs com Filtro
            const searchTerm = document.getElementById('filter-search').value.toLowerCase();
            const searchDate = document.getElementById('filter-date').value; 
            let dateFormatted = "";
            if(searchDate) {
                const [y, m, d] = searchDate.split('-');
                dateFormatted = `${d}/${m}/${y}`;
            }

            const filteredLogs = window.logs.filter(l => {
                const matchText = l.maquina.toLowerCase().includes(searchTerm) || l.quem.toLowerCase().includes(searchTerm);
                const matchDate = searchDate ? l.data === dateFormatted : true;
                return matchText && matchDate;
            });

            document.getElementById('logs-list').innerHTML = filteredLogs.length > 0 ? filteredLogs.map(l => `
                <div class="bg-gray-800 p-4 rounded-xl flex flex-col gap-1 border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] text-gray-500 font-bold uppercase">${l.data} às ${l.hora || '--:--'}</span>
                        <span class="text-yellow-500 font-black">${l.valor}h</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black uppercase text-white">${l.maquina}</span>
                        <span class="text-[10px] italic text-gray-400">${l.quem}</span>
                    </div>
                </div>`).join('') : '<p class="text-center text-gray-600 text-xs py-10 uppercase italic font-bold">Nenhum registro encontrado</p>';
        }
    </script>
</body>
</html>
