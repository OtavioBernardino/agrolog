<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroLog Pro - Relatórios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÕES DO FIREBASE (INSIRA SUAS CHAVES AQUI)
        const firebaseConfig = {
  		apiKey: "AIzaSyCy2_TVj_AXhu2HUlQBUuL3nUkYWGVzA0U",
  		authDomain: "agrolog-f89d7.firebaseapp.com",
 		databaseURL: "https://agrolog-f89d7-default-rtdb.firebaseio.com",
  		projectId: "agrolog-f89d7",
  		storageBucket: "agrolog-f89d7.firebasestorage.app",
  		messagingSenderId: "79965062136",
  		appId: "1:79965062136:web:1361b2e7001ad850288c0d",
  		measurementId: "G-2YKKE82KTD"
		};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const frotaRef = ref(db, 'frota');
        const logsRef = ref(db, 'logs');
        const emailsRef = ref(db, 'emails_alerta');
        const operRef = ref(db, 'operadores');
        const revsRef = ref(db, 'revisoes');

        onValue(frotaRef, (snapshot) => {
            const data = snapshot.val();
            window.frota = data ? Object.values(data) : [];
            window.frotaKeys = data ? Object.keys(data) : [];
            render();
        });

        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            window.logs = data ? Object.values(data).reverse() : [];
            renderLogs();
            renderRelatorios(); // Atualiza relatórios sempre que houver novos logs
        });

        // ... (Mantidas todas as funções de escrita registrarHoras, salvarTrator, etc. do código anterior) ...
        // [As funções de escrita permanecem idênticas para garantir o funcionamento das abas anteriores]
    </script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #side-menu { transition: 0.3s; transform: translateX(-100%); }
        #side-menu.open { transform: translateX(0); }
        .responsive-table td::before { content: attr(data-label); font-weight: bold; color: #9ca3af; font-size: 0.7rem; }
        @media (max-width: 640px) {
            .responsive-table tr { display: block; background: #1f2937; margin-bottom: 0.5rem; border-radius: 0.75rem; padding: 0.5rem; border: 1px solid #374151; }
            .responsive-table td { display: flex; justify-content: space-between; padding: 0.3rem; border: none; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-24">

    <div id="overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/60 z-[60] hidden"></div>

    <div id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 z-[70] shadow-2xl p-6 border-r border-gray-700 overflow-y-auto">
        <h2 class="text-xl font-black text-yellow-400 italic mb-8">CONFIGURAÇÕES</h2>
        <nav class="space-y-1">
            <button onclick="navTo('dashboard')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-th-large"></i> Dashboard</button>
            <button onclick="navTo('relatorios')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4 text-green-400 font-bold"><i class="fas fa-chart-pie"></i> Relatórios de Uso</button>
            <button onclick="navTo('log-horas')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-list"></i> Log de Horas</button>
            <button onclick="navTo('log-rev')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-tools"></i> Revisões Feitas</button>
            <hr class="border-gray-700 my-4">
            <button onclick="navTo('cad-email')" class="w-full text-left p-4 hover:bg-red-900/20 text-red-400 rounded-xl flex gap-4 border border-red-900/30"><i class="fas fa-bell"></i> Alertas de E-mail</button>
            <button onclick="navTo('cad-trator')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-tractor"></i> Frotas</button>
        </nav>
    </div>

    <header class="bg-green-900 p-4 sticky top-0 z-50 flex justify-between items-center border-b border-green-800 shadow-xl">
        <button onclick="toggleMenu()" class="text-xl px-2"><i class="fas fa-bars"></i></button>
        <h1 class="font-black italic text-lg uppercase">Agro<span class="text-yellow-400">Log</span> Cloud</h1>
        <div class="w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_green]"></div>
    </header>

    <main class="p-4 max-w-4xl mx-auto">
        
        <section id="dashboard" class="tab-content active space-y-4">
            <div id="fleet-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="relatorios" class="tab-content space-y-6">
            <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-chart-bar text-green-500"></i> Relatório de Utilização</h2>
            
            <div id="relatorio-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                </div>

            <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700">
                <h3 class="text-sm font-bold uppercase text-gray-400 mb-4">Uso Total por Período (Horas Trabalhadas)</h3>
                <table class="responsive-table w-full">
                    <thead class="hidden md:table-header-group text-[10px] text-gray-500 uppercase">
                        <tr>
                            <th class="text-left p-2">Máquina</th>
                            <th class="text-center p-2">Hoje</th>
                            <th class="text-center p-2">Semana</th>
                            <th class="text-center p-2">Mês</th>
                        </tr>
                    </thead>
                    <tbody id="table-relatorio-uso"></tbody>
                </table>
            </div>
        </section>

        <section id="lancamento" class="tab-content">
            </section>

        <section id="log-horas" class="tab-content">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-history text-yellow-500"></i> Histórico de Horas</h2>
            <table class="responsive-table w-full border-collapse">
                <tbody id="table-logs"></tbody>
            </table>
        </section>

        </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-md border-t border-gray-700 flex justify-around p-2 z-40">
        <button onclick="openTab('dashboard')" class="flex flex-col items-center p-2 text-gray-400"><i class="fas fa-th-large text-xl"></i><span class="text-[9px] font-bold">Status</span></button>
        <button onclick="openTab('relatorios')" class="flex flex-col items-center p-2 text-gray-400"><i class="fas fa-chart-pie text-xl"></i><span class="text-[9px] font-bold">Relat.</span></button>
        <button onclick="openTab('lancamento')" class="relative -mt-10">
            <div class="bg-yellow-600 text-gray-900 w-16 h-16 rounded-full flex items-center justify-center border-[6px] border-gray-900 shadow-2xl"><i class="fas fa-plus text-2xl"></i></div>
        </button>
        <button onclick="openTab('log-horas')" class="flex flex-col items-center p-2 text-gray-400"><i class="fas fa-history text-xl"></i><span class="text-[9px] font-bold">Logs</span></button>
    </nav>

    <script>
        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }
        function navTo(id) { toggleMenu(); openTab(id); }
        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        // LÓGICA DE RELATÓRIOS
        function renderRelatorios() {
            if (!window.logs || !window.frota) return;

            const agora = new Date();
            const hojeStr = agora.toLocaleDateString('pt-BR');
            
            const resumo = {};
            window.frota.forEach(t => resumo[t.modelo] = { d: 0, s: 0, m: 0 });

            // Processar Logs para calcular diferenças de horas
            // Nota: Para precisão total, comparamos o log atual com o anterior daquela máquina específica
            window.frota.forEach(trator => {
                const logsMaq = window.logs.filter(l => l.maquina === trator.modelo).reverse(); // Ordem cronológica
                
                for(let i = 1; i < logsMaq.length; i++) {
                    const diff = parseFloat(logsMaq[i].valor) - parseFloat(logsMaq[i-1].valor);
                    if (diff <= 0) continue;

                    const dataLog = parseData(logsMaq[i].data);
                    const diasDiff = (agora - dataLog) / (1000 * 60 * 60 * 24);

                    if (logsMaq[i].data === hojeStr) resumo[trator.modelo].d += diff;
                    if (diasDiff <= 7) resumo[trator.modelo].s += diff;
                    if (diasDiff <= 30) resumo[trator.modelo].m += diff;
                }
            });

            // Render Cards de Totais
            const totalD = Object.values(resumo).reduce((a, b) => a + b.d, 0);
            const totalS = Object.values(resumo).reduce((a, b) => a + b.s, 0);
            const totalM = Object.values(resumo).reduce((a, b) => a + b.m, 0);

            document.getElementById('relatorio-cards').innerHTML = `
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500">
                    <p class="text-[10px] uppercase font-bold text-gray-400">Trabalho Hoje</p>
                    <p class="text-2xl font-black">${totalD.toFixed(1)}h</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500">
                    <p class="text-[10px] uppercase font-bold text-gray-400">Últimos 7 dias</p>
                    <p class="text-2xl font-black">${totalS.toFixed(1)}h</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-[10px] uppercase font-bold text-gray-400">Últimos 30 dias</p>
                    <p class="text-2xl font-black">${totalM.toFixed(1)}h</p>
                </div>
            `;

            // Render Tabela de Detalhes
            document.getElementById('table-relatorio-uso').innerHTML = Object.keys(resumo).map(maq => `
                <tr class="border-b border-gray-700/50">
                    <td data-label="Máquina" class="p-3 font-bold text-sm">${maq}</td>
                    <td data-label="Hoje" class="p-3 text-center text-blue-400 font-mono">${resumo[maq].d.toFixed(1)}h</td>
                    <td data-label="Semana" class="p-3 text-center text-green-400 font-mono">${resumo[maq].s.toFixed(1)}h</td>
                    <td data-label="Mês" class="p-3 text-center text-yellow-500 font-mono">${resumo[maq].m.toFixed(1)}h</td>
                </tr>
            `).join('');
        }

        function parseData(str) {
            const [d, m, y] = str.split('/');
            return new Date(y, m - 1, d);
        }

        // ... (Restante das funções de renderização do Dashboard e Logs mantidas) ...
    </script>
</body>
</html>
