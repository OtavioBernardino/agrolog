<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroLog Pro Cloud - Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÕES DO FIREBASE (SUBSTITUA PELAS SUAS)
        const firebaseConfig = {
  	apiKey: "AIzaSyCy2_TVj_AXhu2HUlQBUuL3nUkYWGVzA0U",
 	authDomain: "agrolog-f89d7.firebaseapp.com",
  	databaseURL: "https://agrolog-f89d7-default-rtdb.firebaseio.com",
  	projectId: "agrolog-f89d7",
  	storageBucket: "agrolog-f89d7.firebasestorage.app",
  	messagingSenderId: "79965062136",
  	appId: "1:79965062136:web:1361b2e7001ad850288c0d",
  	measurementId: "G-2YKKE82KTD"
	};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referências
        const frotaRef = ref(db, 'frota');
        const operRef = ref(db, 'operadores');
        const logsRef = ref(db, 'logs');
        const revsRef = ref(db, 'revisoes');

        // Sincronização em Tempo Real
        onValue(frotaRef, (snapshot) => {
            const data = snapshot.val();
            window.frota = data ? Object.values(data) : [];
            window.frotaKeys = data ? Object.keys(data) : [];
            render();
        });

        onValue(operRef, (snapshot) => {
            window.oper = snapshot.val() ? Object.values(snapshot.val()) : [];
            render();
        });

        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            window.logs = data ? Object.values(data).reverse() : [];
            render();
        });

        onValue(revsRef, (snapshot) => {
            window.revs = snapshot.val() ? Object.values(snapshot.val()).reverse() : [];
            render();
        });

        // Funções de Escrita Cloud
        window.registrarHoras = (tratorId, operadorNome, horas) => {
            const tIndex = window.frota.findIndex(x => x.id == tratorId);
            const t = window.frota[tIndex];
            const tKey = window.frotaKeys[tIndex];

            set(ref(db, `frota/${tKey}/horimetro`), parseFloat(horas));
            push(logsRef, { 
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                maquina: t.modelo, quem: operadorNome, valor: horas 
            });
        };

        window.salvarTrator = (mod, int, hor) => {
            const n = push(frotaRef);
            set(n, { id: Date.now(), key: n.key, modelo: mod, intervalo: parseFloat(int), horimetro: parseFloat(hor), ultimaRevisao: parseFloat(hor) });
            alert("Máquina Adicionada!");
        };

        window.salvarOperador = (nome) => {
            push(operRef, { id: Date.now(), nome });
            alert("Operador salvo!");
        };

        window.confirmarRevisao = (tratorId) => {
            const tIndex = window.frota.findIndex(x => x.id == tratorId);
            const t = window.frota[tIndex];
            const tKey = window.frotaKeys[tIndex];
            push(revsRef, { data: new Date().toLocaleDateString('pt-BR'), maquina: t.modelo, valor: t.horimetro });
            set(ref(db, `frota/${tKey}/ultimaRevisao`), t.horimetro);
        };
    </script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #side-menu { transition: transform 0.3s; transform: translateX(-100%); }
        #side-menu.open { transform: translateX(0); }
        @media (max-width: 640px) {
            .responsive-table tr { display: block; background: #1f2937; margin-bottom: 0.5rem; border-radius: 0.75rem; padding: 0.5rem; border: 1px solid #374151; }
            .responsive-table td { display: flex; justify-content: space-between; padding: 0.3rem; border: none; font-size: 0.85rem; }
            .responsive-table td::before { content: attr(data-label); font-weight: bold; color: #9ca3af; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-24">

    <div id="overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/60 z-[60] hidden"></div>

    <div id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 z-[70] shadow-2xl p-6 border-r border-gray-700">
        <h2 class="text-xl font-black text-yellow-400 italic mb-10">AGROLOG PRO</h2>
        <nav class="space-y-2">
            <button onclick="navTo('cad-trator')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-tractor text-green-500"></i> Cadastrar Frota</button>
            <button onclick="navTo('cad-oper')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-users text-blue-500"></i> Operadores</button>
            <button onclick="navTo('log-rev')" class="w-full text-left p-4 hover:bg-gray-700 rounded-xl flex gap-4"><i class="fas fa-tools text-orange-400"></i> Revisões Feitas</button>
            <hr class="border-gray-700 my-4">
            <button onclick="location.reload()" class="w-full text-left p-4 text-gray-400 flex gap-4"><i class="fas fa-sync"></i> Atualizar Sistema</button>
        </nav>
    </div>

    <header class="bg-green-900 p-4 sticky top-0 z-50 flex justify-between items-center border-b border-green-800 shadow-xl">
        <button onclick="toggleMenu()" class="text-xl px-2"><i class="fas fa-bars"></i></button>
        <h1 class="font-black italic text-lg uppercase">Agro<span class="text-yellow-400">Log</span> Cloud</h1>
        <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></div>
    </header>

    <main class="p-4 max-w-4xl mx-auto">
        
        <section id="dashboard" class="tab-content active space-y-4">
            <div id="fleet-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="lancamento" class="tab-content">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-2xl">
                <h2 class="text-center font-black uppercase text-yellow-500 mb-6">Lançar Horímetro</h2>
                <form id="form-horas" class="space-y-4">
                    <select id="sel-t" class="w-full bg-gray-900 p-4 rounded-xl border border-gray-700 font-bold" required></select>
                    <select id="sel-o" class="w-full bg-gray-900 p-4 rounded-xl border border-gray-700" required></select>
                    <input type="number" step="0.1" id="h-atual" placeholder="0000.0" class="w-full bg-gray-900 p-6 rounded-2xl border-2 border-yellow-600 text-center text-5xl font-black text-yellow-500 outline-none" required>
                    <button class="w-full bg-yellow-600 text-gray-900 py-5 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition">Sincronizar</button>
                </form>
            </div>
        </section>

        <section id="log-horas" class="tab-content">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-list text-yellow-500"></i> Log de Trabalho</h2>
            <table class="responsive-table w-full">
                <tbody id="table-logs"></tbody>
            </table>
        </section>

        <section id="log-rev" class="tab-content">
            <h2 class="text-xl font-bold mb-6 italic text-orange-400">Manutenções Concluídas</h2>
            <div id="timeline-rev" class="space-y-4"></div>
        </section>

        <section id="cad-trator" class="tab-content">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="font-bold mb-4 text-green-400 uppercase">Novo Trator</h2>
                <input type="text" id="t-mod" placeholder="Modelo" class="w-full bg-gray-900 p-4 mb-2 rounded-xl border border-gray-700">
                <input type="number" id="t-int" placeholder="Intervalo (h)" class="w-full bg-gray-900 p-4 mb-2 rounded-xl border border-gray-700">
                <input type="number" id="t-hor" placeholder="Horímetro Inicial" class="w-full bg-gray-900 p-4 mb-4 rounded-xl border border-gray-700">
                <button onclick="window.salvarTrator(document.getElementById('t-mod').value, document.getElementById('t-int').value, document.getElementById('t-hor').value)" class="w-full bg-green-600 py-4 rounded-xl font-black uppercase">Cadastrar</button>
            </div>
        </section>

        <section id="cad-oper" class="tab-content">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <h2 class="font-bold mb-4 text-blue-400 uppercase">Novo Operador</h2>
                <input type="text" id="o-nome" placeholder="Nome do Operador" class="w-full bg-gray-900 p-4 mb-4 rounded-xl border border-gray-700">
                <button onclick="window.salvarOperador(document.getElementById('o-nome').value)" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase">Adicionar</button>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-md border-t border-gray-700 flex justify-around p-2 z-40">
        <button onclick="openTab('dashboard')" class="flex flex-col items-center p-2 text-gray-400 hover:text-white transition">
            <i class="fas fa-th-large text-xl"></i><span class="text-[9px] font-bold mt-1 uppercase">Frota</span>
        </button>
        <button onclick="openTab('lancamento')" class="relative -mt-10">
            <div class="bg-yellow-600 text-gray-900 w-16 h-16 rounded-full flex items-center justify-center border-[6px] border-gray-900 shadow-2xl active:scale-90 transition">
                <i class="fas fa-plus text-2xl"></i>
            </div>
        </button>
        <button onclick="openTab('log-horas')" class="flex flex-col items-center p-2 text-gray-400 hover:text-white transition">
            <i class="fas fa-history text-xl"></i><span class="text-[9px] font-bold mt-1 uppercase">Logs</span>
        </button>
    </nav>

    <script>
        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function navTo(id) { toggleMenu(); openTab(id); }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        document.getElementById('form-horas').onsubmit = (e) => {
            e.preventDefault();
            window.registrarHoras(document.getElementById('sel-t').value, document.getElementById('sel-o').value, document.getElementById('h-atual').value);
            e.target.reset();
            alert("Lançamento Sincronizado!");
            openTab('dashboard');
        };

        function render() {
            if(!window.frota) return;

            // Dashboard Cards
            document.getElementById('fleet-list').innerHTML = window.frota.map(t => {
                const perc = Math.min(((t.horimetro - t.ultimaRevisao) / t.intervalo) * 100, 100);
                return `
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <div class="flex justify-between mb-2"><b>${t.modelo}</b><span>${t.horimetro}h</span></div>
                    <div class="w-full bg-gray-900 h-3 rounded-full overflow-hidden mb-4">
                        <div class="h-full ${perc > 90 ? 'bg-red-500 animate-pulse' : 'bg-green-600'}" style="width: ${perc}%"></div>
                    </div>
                    <button onclick="window.confirmarRevisao('${t.id}')" class="w-full bg-blue-600/20 text-blue-400 border border-blue-600/30 py-2 rounded-xl text-[10px] font-black uppercase">Revisar Agora</button>
                </div>`;
            }).join('');

            // Tabela de Horas
            document.getElementById('table-logs').innerHTML = window.logs.map(l => `
                <tr class="hover:bg-gray-800/50">
                    <td data-label="Data/Hora" class="p-3 text-[10px] text-gray-500">${l.data} ${l.hora || ''}</td>
                    <td data-label="Máquina" class="p-3 font-bold text-yellow-500">${l.maquina}</td>
                    <td data-label="Operador" class="p-3 text-sm italic">${l.quem}</td>
                    <td data-label="Horímetro" class="p-3 text-right font-black">${l.valor}h</td>
                </tr>
            `).join('');

            // Timeline de Revisões
            document.getElementById('timeline-rev').innerHTML = window.revs.map(r => `
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-orange-500 flex justify-between items-center">
                    <div><p class="font-bold">${r.maquina}</p><p class="text-[10px] text-gray-400">${r.data}</p></div>
                    <p class="text-xs font-mono font-bold">${r.valor}h</p>
                </div>
            `).join('');

            // Selects
            document.getElementById('sel-t').innerHTML = window.frota.map(t => `<option value="${t.id}">${t.modelo}</option>`).join('');
            document.getElementById('sel-o').innerHTML = window.oper.map(o => `<option value="${o.nome}">${o.nome}</option>`).join('');
        }
    </script>
</body>
</html>
